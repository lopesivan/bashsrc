#!/bin/bash

#-------------------------------------------------------
# Script: bashsrc (util)
# Descrição: Utilitário para consulta de documentações
# Desenvolvido por: Juliano Santos [SHAMAN]
#-------------------------------------------------------

readonly BASENAME=${0##*/}
readonly BASHSRC_VERSION=0.1.2-alpha

if [[ ${#@} -eq 0 ]]; then
	echo "Uso: $BASENAME [OPÇÕES]"
	echo "Tente '$BASENAME --help' para mais informações."
	exit 0
elif [[ ${BASH_VERSINFO[0]} -lt 4 ]]; then
	exec 1>&2
	echo "$BASENAME: erro: versão do 'bash' incompatível."
	echo "atual: $BASH_VERSION" 
	echo "requerida: 4.0 ou superior"
	exit 1
elif [[ ! $BASHSRC_PATH ]]; then
	man ./intro.gz
	exit 1
elif [[ ! -d "$BASHSRC_PATH" ]]; then
	echo "$BASENAME: erro: '$BASHSRC_PATH' diretório não encontrado" 1>&2
	exit 1
fi

function usage()
{
	echo "$BASENAME: ferramenta para consulta de documentação e ambiente."
	echo "Uso: $BASENAME [OPÇÕES]"
	echo
	echo "Argumentos obrigatórios para opções longas também são para opções curtas."
	echo
	echo "-l, --list                    - Lista os sources disponíveis em '\$BASHSRC_PATH'"
	echo "-e, --env                     - Exibe o ambiente configurado em '\$BASHSRC_PATH'."
	echo "-d, --doc <src>[.funcname]    - Exibe a documentação do source ou função."
	echo "                                'src' refere-se ao nome da biblioteca a ser"
	echo "                                consultada, omitindo a extensão '.sh' do arquivo."
 	echo "                                Se '.funcname' for omitido é retornado o protótipo"
	echo "                                de todas as funções disponíveis em 'src'."
	echo "-c, --check-conflicts           Verifica se há conflito de tipos em bibliotecas."
	echo "-h, --help                      Exibe ajuda e sai."
	echo "-v, --version                   Exibe a versão e sai."
	echo
	echo "Para visualizar a documentação inicial, digite:"
	echo "$ $BASENAME man"

	exit 1
}

function view_doc()
{
	local srcname=(${1/./ })
	local srcfile=${srcname[0]}.sh
	local srcdir=$BASHSRC_PATH/src
	local line var flags match comm about prefix

	if [[ ${#srcname[@]} -eq 0 ]]; then
		echo "$BASENAME: nome do source requerido" 1>&2
		return 1
	elif [[ ! -e "$srcdir/$srcfile" ]]; then
		echo "$BASENAME: $srcname: source não encontrado" 1>&2
		return 1
	fi
	
	shopt -s extglob
	set -f
	
	comm='^\s*#'

	if [[ ${#srcname[@]} -eq 1 ]]; then
		
		var='^\s*(readonly|(typeset|declare)\s+-[a-zAF]*r[a-zAF]*)\s+[a-zA-Z]+[a-zA-Z_]*=.*'
		flags='^\s*#\s*(func|type)\s+[a-zA-Z0-9.-]+[a-zA-Z0-9._-]*.*'

		while read line; do
			if [[ $line =~ ($var|$flags) ]]; then
				echo ${line#+(#)}
			fi
		done < "$srcdir/$srcfile"
	else
		
		prefix=${1#builtin.}; prefix=${prefix##*/}	
		flags="^\s*#\s*(func\s+$prefix|(type|const|var|array|map)\s+${1#*.})"
		
		while read line; do
			if [[ ! $match ]]; then
				if [[ $line =~ $flags ]]; then
					echo "${line#+(#)}"
					match=1
				fi
			elif [[ $line =~ $comm ]]; then
				echo "${line#+(#)}"
			else
				break
			fi
		done < "$srcdir/$srcfile"
		
		[[ $match ]] || echo "$BASENAME: '$1' função/documentação não encontrada" 1>&2
	fi
	
	return 0
}

function check_conflicts()
{
   local srcfile cur old srcfile line c
   local re='^[^#]*(SRC|__BUILTIN)_TYPE_IMPLEMENTS\[([^]]+)\]='
   local listdir="$BASHSRC_PATH/src"

	while read cur; do
		if [[ "${old%|*}" == "${cur%|*}" ]]; then
			[[  $c ]] || echo -e "Conflito(s):\n"
			echo "Tipo: ${old%|*}"
			echo "Source 1: ${old#*|}"
			echo "Source 2: ${cur#*|}"
			echo
			c=1
		fi
		old="$cur"
	done < <(while [[ $listdir ]]; do
				for dir in "${listdir[@]}"; do
					unset listdir
					for srcfile in "$dir/"*; do
						if [[ -d "$srcfile" ]]; then
							listdir+=("$srcfile")
						else
							while read line; do
								[[ "$line" =~ $re ]] && echo "${BASH_REMATCH[2]}|$srcfile"
							done < "$srcfile"
						fi
					done
				done
			done | sort -d -t'|' -k1)

	[[  $c ]] || echo "[OK]"

	return ${c:-0}
}

function list_sources()
{
	local dir file c
	local listdir="$BASHSRC_PATH/src"

	while [[ $listdir ]]; do
		for dir in "${listdir[@]}"; do
			unset listdir
			for file in "$dir/"*; do
				if [[ -d "$file" ]]; then
					listdir+=("$file")
				else
					echo "$file"
					((c++))
				fi
			done
		done
	done

	echo -e '-------------\nTotal:' $c
	
	return 0
}

case $1 in
	-d|--doc) view_doc $2;;
	-l|--list) list_sources;;
	-e|--env) printf "BASHSRC_PATH=%s\nPATH=%s\n" $BASHSRC_PATH $PATH;;
	-c|--check-conflicts) check_conflicts;;
	-h|--help) usage;;
	-v|--version) echo "$BASENAME $BASHSRC_VERSION";;
	man) man $BASHSRC_PATH/bin/intro.gz;;
	*) 	echo "$BASENAME: '$1' opção inválida" 1>&2
		echo "Tente '$BASENAME --help' para mais informações." 1>&2;;
esac

exit $?
